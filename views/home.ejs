<% include partials/header %>
<script>
	$("#home").addClass("active");
	$("#title").text("Hjem");

    function updateCalories(mealId) {

        let checkButton = $("." + mealId);
        checkButton.prop("disabled", true);

        const url = "/meal-plan/update/<%=user._id%>/mealId/" + mealId;
        let caloriesToday = $("#caloriesToday");
        $.ajax({
            url: url,
            type: 'post',
        })
        .done(function( data ) {
			caloriesToday.html(data.newCalories);
			location.reload();
        });
    }
</script>

<div class="">		
<% if(nextMeal.name) { %>
	<!-- MEAL CARD -->
	<div class="card mx-0 my-4 ">
		<div class="card-header bg-success text-white">
			<h6 class="mb-0"> 
				<%= user.foodStats.mealPlan.caloriesToday %> kalorier tilbage ud af <%= user.foodStats.mealPlan.totalCalories %>
				<i class="fa fa-lg fa-cutlery float-right" aria-hidden="true"></i>
			</h6>		
		</div>
		<div class="card-body py-2 pr-3">
			<p class="mb-0">Næste måltid: <%= nextMeal.name %>
				<span>
					<button class="mr-0 btn btn-sm btn-outline-success float-right submit <%= nextMeal.id %>" onclick="updateCalories(<%= nextMeal.id %>)">
						<i class="fa fa-check fa-lg" aria-hidden="true"></i>
					</button>
				</span>
			</p>
		</div>
	</div>
<% } else { %>
	<!-- MEAL CARD -->
	<div class="card mx-0 my-4">
		<div class="card-header">
			<h6 class="mb-0"> Du har spist alle dine måltider i dag 
				<span class="ml-1 text-success">
					<i class="fa fa-lg fa-thumbs-o-up" aria-hidden="true"></i>						
				</span>  
			</h6>
		</div>
		<div class="card-body py-2">
			<h6> I dag har du indtaget: </h6>
			<p class="mb-0"> Kalorier <span class="float-right"> <%= user.foodStats.mealPlan.totalCalories %> kcal  </span> </p>
			<p class="mb-0"> Kulhydrater <span class="float-right"> <%= user.foodStats.mealPlan.totalCarbohydrates %>g  </span> </p>
			<p class="mb-0"> Fedt <span class="float-right"> <%= user.foodStats.mealPlan.totalFat %>g  </span> </p>
			<p class="mb-0"> Protein <span class="float-right"> <%= user.foodStats.mealPlan.totalProtein %>g  </span> </p>
		</div>
	</div>
<% } %>

<!-- WEIGHT CARD -->
	<div class="card mx-0 my-4">
		<div class="card-header bg-primary text-white">
			<h6 class="mb-0">
				Nuværende vægt: <%= user.weightStats.currentWeight %>kg
				<i class="fa fa-lg float-right fa-area-chart" aria-hidden="true"></i>
			</h6>
		</div>
		<div class="card-body">
			<% if(user.weightStats.weightProgress != null && user.weightStats.weightProgress != 0){ %>
				<% if(user.weightStats.weightProgress < 0){ %>
					<p>Du har taget <%= Math.abs(user.weightStats.weightProgress).toFixed(1) %>kg på siden du startede</p>
				<% } else { %>
					<p>Du har tabt dig <%= Math.abs(user.weightStats.weightProgress).toFixed(1) %>kg siden du startede</p>
				<% } %>
			<% } %>	
			<form action="/update/weight" method="POST">
				<div class="form-row">
					<div class="form-group col-8">
						<input class="form-control" type="number" name="weight" step="0.1"/>
					</div>
					<div class="form-group col-4">
						<input class="form-control btn btn-outline-primary" type="submit"/>	
					</div>
				</div>
			</form>
			<canvas id="myChart" width="100" height="80"></canvas>
		</div>
	</div>


</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.min.js"></script>
<script>

	var ctx = $("#myChart");

	var myChart = new Chart(ctx, {
		type: 'line',
		data: {

			<% 
			let weightDates = []
			let allWeights = []

			user.weightStats.allWeights.forEach((weight) => {
				weightDates.push(JSON.stringify(weight.date));
				allWeights.push(weight.weight);
			}); 

			%>

			labels: [<%- weightDates %>],
			datasets: [{
				label: '# Vægt',
				data: [<%= allWeights %>],
				backgroundColor: [
					'rgba(2,117,216, .7)',
				],
				borderColor: [
					'rgba(0, 0, 0, 0.5)',
				],
				borderWidth: 1,
				fill: true
			}],
		},
		options: {
			scales: {
				yAxes: [{
					ticks: {
						beginAtZero:false
					}
				}]
			}
		}
	});


</script>

<% include partials/footer %>